---
layout: ../../../../layouts/PostLayout.astro
title: å¤šç§Ÿæˆ¶ç³»çµ±è³‡æ–™éš”é›¢
imgSrc: 
slug: 2022/03/å¤šç§Ÿæˆ¶ç³»çµ±è³‡æ–™éš”é›¢
---

  
ä¸€èˆ¬å°ˆæ¡ˆåªéœ€è¦ä¸€å° DBï¼Œç„¶å¾Œç”¨ project_id å€éš”è³‡æ–™å°±å¥½<br>
ä¸éå› ç‚ºå…¬å¸çš„æ–°å°ˆæ¡ˆå°è³‡å®‰æœ‰å¾ˆé«˜éœ€æ±‚ï¼Œé–‹å§‹å°å…¥å¤šç§Ÿæˆ¶ç³»çµ±çš„æ¦‚å¿µï¼Œ<br>
é€™ç¯‡æ–‡ç« æœƒè¬›è§£åœ¨ DB ä¸Šå„ç¨®è³‡æ–™éš”é›¢çš„æ¨¡å¼ï¼Œä»¥åŠ Cognitoã€EC2 è¦å¦‚ä½•æ­é…å¯¦ç¾







<br><br>



  
ä¸€èˆ¬ä¾†èªªï¼Œéƒ½æ˜¯æ¶ä¸€å° DBã€ä¸€ä»½ schemaï¼Œåœ¨é€éæ¯ä¸€ç­†è³‡æ–™ä¸Šçš„ project_id æˆ– tenant_id åšéæ¿¾



[](https://medium.com/cyberark-engineering/multi-tenancy-architecture-of-a-relational-database-afe3548fd8bb)[Multi-tenancy architecture of a relational database](https://medium.com/cyberark-engineering/multi-tenancy-architecture-of-a-relational-database-afe3548fd8bb) çš„ **Single database, discriminator column for data partitioning**



  
é€™ç¨®ä½œæ³•å¤§æ¦‚æœ‰ä»¥ä¸‹çš„ç¼ºé»ï¼š



  
- è³‡æ–™å¯¦éš›ä¸Šæ²’æœ‰éš”é–‹  
- å·¥ç¨‹å¸«å¯«éŒ¯ SQL æ™‚ï¼Œç³»çµ±æœƒæŠ“å‡ºå…¶ä»–å°ˆæ¡ˆçš„è³‡æ–™  
- å¾ table æŠ“å‡ºæŒ‡å®šå°ˆæ¡ˆçš„è³‡æ–™ç›¸å°æµªè²»æ•ˆèƒ½ï¼ˆå› ç‚º tenant_id çš„ [cardinality å¤ªä½](https://kylinyu.win/mysql-index-cardinality/)ä»¥è‡³æ–¼å³ä½¿åŠ äº† index ä¹Ÿé‚„æ˜¯æœƒ full table scanï¼‰



  
å¹³æ™‚é–‹ç™¼å°ˆæ¡ˆéƒ½æ˜¯ç”¨é€™ç¨®ä½œæ³•ï¼Œå› ç‚º data-isolation çš„è¦æ±‚ä¸¦ä¸é«˜ï¼ŒçœŸçš„éœ€è¦åšè·¨å°ˆæ¡ˆåˆ†ææ™‚ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚<br>
ä½†ä»¥æ‰‹é ­ä¸Šé€™å°ˆæ¡ˆçš„è³‡å®‰è¦æ±‚ä¾†èªªï¼Œé€™ç¨®åšæ³•æ‡‰è©²æ˜¯ä¸è¡Œçš„ğŸ¥²



<br><br>



  
## é‚£éº¼é‚„æœ‰å“ªäº›æ–¹å¼å‘¢ï¼Ÿ



  
1. 1 db instanceã€1 schemaã€**tenant_id column**ï¼ˆä¸Šé¢èªªçš„ï¼‰  
2. 1 db instanceã€**n schema**ï¼ˆå¹¾å€‹å°ˆæ¡ˆå°±æœ‰å¹¾å€‹ schemaï¼Œå„è‡ªåš migrationï¼‰  
3. **n db instance**ï¼ˆå¹¾å€‹å°ˆæ¡ˆå°±é–‹å¹¾å°æ©Ÿå™¨ï¼‰



  
æˆ‘è¦ºå¾—ç¬¬äºŒç¨®åšæ³•æ˜¯åœ¨ cost-efficiency è·Ÿ security æ¯”è¼ƒå¹³è¡¡çš„åšæ³•



<br><br>



  
## MySQL (RDS) å¦‚ä½•æ­é…å¤šç§Ÿæˆ¶æ¨¡å¼



  
æ‰¿ç¬¬äºŒç¨®ä½œæ³•ï¼ˆ1 db instanceã€**n schema**ï¼‰



  
æ¯ç•¶è¦å»ºç«‹æ–°å°ˆæ¡ˆçš„æ™‚å€™ï¼Œå‡è¨­ tenant_id = foobarï¼š



  
1. Create schema named `mycoolsys-foobar`  
2. Create user named `user-foobar`  
3. Grant schema access for user created in previous step  
4. Migration  
5. (Optional) Store username and password of `user-foobar` in vault service(e.g. [Secrets Manager](https://aws.amazon.com/tw/secrets-manager/))



  
#### åœ¨ Terraform ä¸­è‡ªå‹•åŒ–ä¸Šè¿°ç¨‹åº



  
å¦‚æœèƒ½æŠŠæ¯æ¬¡éƒ¨å±¬æ–°å°ˆæ¡ˆéœ€è¦çš„è³‡æºæ‰“åŒ…æˆ moduleï¼Œ<br>
å°±å¯ä»¥å¯« Lambda ç”¨ admin account é€² DB ä¸‹æŒ‡ä»¤ï¼Œä¸¦ç”¨ [aws_lambda_invocation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_invocation) åŸ·è¡Œ



<br><br>



  
## Cognito å¦‚ä½•æ­é…å¤šç§Ÿæˆ¶æ¨¡å¼



  
å®˜æ–¹æ–‡ä»¶å…¶å¯¦æœ‰ç‰¹åˆ¥æåˆ°å„ç¨®[å¯¦ä½œæ–¹å¼](https://docs.aws.amazon.com/cognito/latest/developerguide/multi-tenant-application-best-practices.html)åŒ…æ‹¬ï¼š



  
1. **n user-pool**  
2. 1 user-poolã€**n client**  
3. 1 user-poolã€1 clientã€**n group**  
4. 1 user-poolã€1 clientã€**custom-attribute based multi-tenancy**



  
å°±çœ‹è‡ªå·±éœ€è¦æ±ºå®šè¦å“ªç¨®å›‰



  
ä¸éï¼<br>
å¦‚æœä½ è¦ç”¨ **n user-pool** æ­é… API Gatewayï¼Œè¨˜å¾— **Do not use HTTP API, use REST API instead**ï¼<br>
å› ç‚º HTTP API çš„ [JWT Issuer åªèƒ½è¨­å®šä¸€çµ„](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/apigatewayv2_authorizer#issuer)ï¼ˆé™¤éä½ é¡˜æ„ n user-pool ğŸ¤ n api-gatewayï¼‰<br>
åè€Œ REST API  å¯ä»¥[ç›´æ¥è¨­å®šå¤šçµ„ provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_authorizer#provider_arns)



<br><br>



  
## EC2 å¦‚ä½•æ­é…å¤šç§Ÿæˆ¶æ¨¡å¼



  
æ‰¿ç¬¬äºŒç¨®ä½œæ³•ï¼ˆ1 db instanceã€**n schema**ï¼‰



  
æ¯ä¸€å€‹å°ˆæ¡ˆå°±é–‹ä¸€å° ec2 instanceï¼Œä¸¦ä¸”æŒ‡å®šä»–ç”¨ä¸‹é¢çš„è³‡è¨Šé€£åˆ° MySQLï¼š



  
```
DB_HOST     = "domain to your instance"
DB_SCHEMA   = "mycoolsys_foobar"
DB_USERNAME = "user_foobar"
DB_PASSWORD = ""
```



  
æ­¤æ™‚é‚„èƒ½æ­é… [EC2 ä¸ç”¨å¯†ç¢¼é€£ç·šåˆ° RDS (MySQL)](https://blog.artyomliou.ninja/2022/03/ec2-%e4%b8%8d%e7%94%a8%e5%af%86%e7%a2%bc%e9%80%a3%e7%b7%9a%e5%88%b0-rds-mysql/) é€™ç¯‡æ–‡ç« ä¸­æ‰€èªª RDS Proxy çš„æ¶æ§‹ï¼ˆ ec2 instance åªèƒ½ä½¿ç”¨ç‰¹å®šä¸€çµ„åœ¨ RDS Proxy äº‹å…ˆç¶å®šçš„ DB secrets ä¸¦é€£ç·šåˆ° RDSï¼Œå†é€é RDS Instance å…§å°è©² db user åŠ ä¸Š privilege é™åˆ¶ï¼‰ï¼Œä»¥å¯¦ç¾ç‰¹å®šç§Ÿæˆ¶çš„ ec2 instance åªèƒ½å­˜å–è‡ªå·±çš„ schemaã€‚
